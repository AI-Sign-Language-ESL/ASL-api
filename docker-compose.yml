version: "3.9"

services:
  # =========================
  # Backend (Django + Channels)
  # =========================
  backend:
    build:
      context: ./backend
    container_name: tafahom-backend
    command: >
      daphne tafahom.asgi:application
      -b 0.0.0.0
      -p 8000
    ports:
      - "8000:8000"
    environment:
      DJANGO_SETTINGS_MODULE: tafahom.settings
      DJANGO_ENV: production

      # ðŸ”— Database
      DB_NAME: tafahom
      DB_USER: tafahom
      DB_PASSWORD: tafahom
      DB_HOST: postgres
      DB_PORT: 5432

      # ðŸ”— AI service

    depends_on:
      - postgres
      - ai

    restart: unless-stopped


  # =========================
  # PostgreSQL Database
  # =========================
  postgres:
    image: postgres:16-alpine
    container_name: tafahom-postgres
    environment:
      POSTGRES_DB: tafahom
      POSTGRES_USER: tafahom
      POSTGRES_PASSWORD: tafahom
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"   # optional (for pgAdmin / local access)
    restart: unless-stopped


  # =========================
  # AI Service (gRPC + GPU)
  # =========================
  ai:
    build:
      context: ./ai_service
    container_name: tafahom-ai
    ports:
      - "50051:50051"
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]


volumes:
  postgres_data:
